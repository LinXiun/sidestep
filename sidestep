local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRoot = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

-- CONFIG
local DashDistance = 60
local DashTime = 0.08
local Interval = 0.1
local MoveThreshold = 0.1 -- detect manual movement

-- Optional trail
local function createTrail()
	local trail = Instance.new("Trail")
	trail.Lifetime = 0.1
	trail.Transparency = NumberSequence.new(0.2, 1)
	trail.Color = ColorSequence.new(Color3.fromRGB(255,0,0), Color3.fromRGB(255,150,0))
	local a0 = Instance.new("Attachment", humanoidRoot)
	local a1 = Instance.new("Attachment", humanoidRoot)
	a0.Position = Vector3.new(0,2,0)
	a1.Position = Vector3.new(0,-2,0)
	trail.Attachment0 = a0
	trail.Attachment1 = a1
	trail.Parent = humanoidRoot
	game.Debris:AddItem(trail,0.25)
end

-- Fixed-position rotatable camera
local cameraConnection
local function lockCameraPosition()
	local fixedPosition = camera.CFrame.Position
	camera.CameraType = Enum.CameraType.Scriptable

	cameraConnection = RunService:BindToRenderStep("FixedCameraRotatable", Enum.RenderPriority.Camera.Value, function()
		local rotation = camera.CFrame - camera.CFrame.Position
		camera.CFrame = CFrame.new(fixedPosition) * rotation
	end)
end

local function unlockCameraPosition()
	if cameraConnection then
		RunService:UnbindFromRenderStep("FixedCameraRotatable")
		cameraConnection = nil
		camera.CameraType = Enum.CameraType.Custom -- restore normal follow
	end
end

-- Sidestep loop
local function sidestepLoop()
	lockCameraPosition()
	local dir = -1
	local lastDash = 0

	local conn
	conn = RunService.RenderStepped:Connect(function()
		-- Stop if player manually moves
		if humanoid.MoveDirection.Magnitude > MoveThreshold then
			conn:Disconnect()
			unlockCameraPosition()
			return
		end

		if tick() - lastDash >= Interval then
			dir = -dir
			createTrail()
			local moveDir = humanoidRoot.CFrame.RightVector * dir
			local targetPos = humanoidRoot.Position + moveDir * DashDistance
			local tween = TweenService:Create(
				humanoidRoot,
				TweenInfo.new(DashTime, Enum.EasingStyle.Linear),
				{CFrame = CFrame.new(targetPos, targetPos + humanoidRoot.CFrame.LookVector)}
			)
			tween:Play()
			lastDash = tick()
		end
	end)
end

-- Start sidestep automatically
task.defer(function()
	task.wait(1)
	sidestepLoop()
end)

-- Reapply on respawn
player.CharacterAdded:Connect(function(newChar)
	character = newChar
	humanoidRoot = newChar:WaitForChild("HumanoidRootPart")
	humanoid = newChar:WaitForChild("Humanoid")
	task.wait(1)
	sidestepLoop()
end)